<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UPI QR Scanner & Modifier</title>

    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- QR Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 15px;
            text-align: center;
        }
        #reader {
            width: 320px;
            margin: auto;
            border-radius: 10px;
            overflow: hidden;
        }
        #reader video {
            transform: scale(1.15); /* Helps Samsung wide-angle issue */
        }
        .box {
            background: #ffffff;
            padding: 12px;
            margin: 12px auto;
            max-width: 520px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        pre {
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 14px;
        }
        #qrcode {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h2>UPI QR Scanner & Modifier</h2>
<p>Samsung-optimized • Encoding-safe</p>

<div id="reader"></div>

<div class="box">
    <h3>Decoded UPI URI</h3>
    <pre id="decoded">Waiting for scan...</pre>
</div>

<div class="box">
    <h3>Modified UPI URI (₹1.00)</h3>
    <pre id="modified">—</pre>
</div>

<div class="box">
    <h3>Generated QR Code</h3>
    <div id="qrcode"></div>
</div>

<script>
    /* ---------- ENCODING-SAFE UPI MODIFIER ---------- */
    function modifyUpiUri(upiUri) {
        const parts = upiUri.split("?");
        if (parts.length !== 2) return upiUri;

        const base = parts[0];
        const params = parts[1].split("&");

        const updatedParams = params.map(p => {
            if (p.startsWith("am=")) return "am=1.00";
            if (p.startsWith("mam=")) return "mam=1.00";
            return p; // preserve original encoding
        });

        return base + "?" + updatedParams.join("&");
    }

    function generateQR(text) {
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: text,
            width: 220,
            height: 220
        });
    }

    function onScanSuccess(decodedText) {
        if (!decodedText.startsWith("upi://")) return;

        document.getElementById("decoded").textContent = decodedText;

        const modified = modifyUpiUri(decodedText);
        document.getElementById("modified").textContent = modified;

        generateQR(modified);

        html5QrCode.stop();
    }

    async function startBestCamera() {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) {
            alert("No cameras found");
            return;
        }

        let bestCamera = devices[0];

        devices.forEach(device => {
            const label = device.label.toLowerCase();
            if (
                label.includes("back") ||
                label.includes("rear") ||
                label.includes("main")
            ) {
                bestCamera = device;
            }
        });

        window.html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            bestCamera.id,
            {
                fps: 12,
                qrbox: { width: 260, height: 260 },
                disableFlip: true
            },
            onScanSuccess
        );
    }

    startBestCamera();
</script>

</body>
</html>
